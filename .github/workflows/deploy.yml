name: deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Generate config.json with secrets
      run: |
        echo "Creating config.json..."
        if [ -z "${{ secrets.MAPBOX_TOKEN }}" ]; then
          echo "WARNING: MAPBOX_TOKEN secret is empty or not set!"
          echo "Creating config.json with placeholder..."
          cat > project/config.json << EOF
        {
          "mapbox_token": "SECRET_NOT_CONFIGURED"
        }
        EOF
        else
          echo "MAPBOX_TOKEN secret found, creating config.json..."
          cat > project/config.json << EOF
        {
          "mapbox_token": "${{ secrets.MAPBOX_TOKEN }}"
        }
        EOF
        fi
        
    - name: Verify config.json was created
      run: |
        echo "Checking if config.json exists..."
        ls -la project/
        echo "Content of config.json:"
        cat project/config.json
        echo "Directory structure before upload:"
        find . -name "*.json" -type f

    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
